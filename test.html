<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .main, .start_bg, .text_bg, .image_bg {
            position: fixed;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
        }

        .main{
            background-color: #d2c8c5;
            overflow: hidden;
        }

        .text_bg {
            position: absolute;
            background: transparent;
            top: 16%;
            left: 16%;
            right: 16%;
            bottom: 50%;
            text-align: center;
        }

        .line {
            margin: 8px 0px;
        }

        .text {
            display: inline-block;
            font-size: 20px;
            font-weight: bold;
            font-family: cursive;
            color: #000000;
            animation: flexing 3s ease-in infinite;
            z-index: 9;
        }

        @keyframes flexing {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
            60% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(0.8);
                opacity: 0.8;
            }
        }

        .imageLine {
            margin: 1px 4px;
        }

        .blankImage, .image {
            display: inline-block;
            margin: 0px 1px;
            border: 1px solid lavender;
            border-radius: 5px;
            text-align: center;
            opacity: 0;
        }

        .image {
            opacity: 1;
            background-color: #cbc4c5;
            animation: imageFlexing 3s ease-in infinite;
            animation-delay: 500ms;
        }

        .center_image {
            position: fixed;
            border-radius: 5px;
            top: 30%;
            bottom: 30%;
            right: 35%;
            left: 35%;
            background: gray;
        }

        .center_image_portrait {
            position: fixed;
            border-radius: 5px;
            top: 45%;
            bottom: 30%;
            right: 27%;
            left: 30%;
        }

        .center_imageFlexing{
            animation: centerImageFlexing 3s ease-in 1;
        }

        @keyframes centerImageFlexing {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(2.5);
            }
        }

    </style>
    <script src="js/jquery.min.js"></script>
    <script src="js/coordinate.js"></script>
    <script src="js/const.js"></script>
</head>
<body>
<div class="main">
    <div class="text_bg"></div>
</div>
<script type="text/javascript">
    function makeLargeShape() {

        var mainDiv = document.getElementsByClassName('main')[0];
        var totalWidth = mainDiv.offsetWidth, totalHeight = mainDiv.offsetHeight;
        console.log(totalWidth + '=====' + totalHeight);

        var rows = 13, columns = 30;
        var mode = totalWidth > totalHeight ? 'landscape' : 'portrait';

        if(mode == 'portrait'){
            columns = 15;
            rows = 32;
        }
        var coordinates = null;
        if(mode == 'portrait') {
            coordinates = Coordinate.makePortraitCoordinates(1,1,1);
        }else{
            coordinates = Coordinate.makeCoordinates(1,1,1);
        }
        //x = (w-2cm-2cb)/c; w总高度，c总列数，m marginRight,marginLeft的值, b border的值
        //y = (h -2mr -4r)/r
        var imageWidth = Math.floor((totalWidth - 8 - columns * 2 * 1 - 2 * columns * 1)/ columns),
            imageHeight = Math.floor((totalHeight - rows * 2 * 1 - 4 * rows) / rows);

        for (var i = 0; i < rows; i++) {
            var imageLine = document.createElement('div');
            imageLine.classList.add('imageLine');
            mainDiv.appendChild(imageLine);

            for (var j = 0; j < columns; j++) {
                var coordinate = new Coordinate(i, j);
                var imageDiv = document.createElement('div');
                // if(coordinates.containsCoordinate(coordinate)){
                //     imageDiv.classList.add('image');
                // }else{
                //     imageDiv.classList.add('blankImage');
                // }

                imageDiv.classList.add('image');

                imageDiv.style.width = imageWidth + 'px';
                imageDiv.style.height = imageHeight + 'px';
                // imageDiv.innerHTML = '<b>' + i + '-' + j + '</b>';
                imageDiv.innerHTML = '&nbsp;';
                imageLine.appendChild(imageDiv);
            }
        }
        setTimeout(restart, project.waitingTime);
    }


    function showImageFlows(){
        var imageUrls = project.images.slice();
        function showImage(){
            var container = project.container;
            var class_name = project.mode == 'portrait' ? 'center_image_portrait' : 'center_image';
            var imageDiv = document.getElementsByClassName(class_name)[0];

            if(imageDiv){
                container.removeChild(imageDiv);
            }
            var imageUrl = imageUrls.shift();
            if(!imageUrl){
                project.imageEnd = true;
                if(project.textEnd){
                    setTimeout(makeLargeShape, 1000);
                }
                return;
            }

            imageDiv = document.createElement('div');
            imageDiv.classList.add(project.mode == 'portrait' ? 'center_image_portrait' : 'center_image');

            imageDiv.style.background = 'transparent url(' + imageUrl + ')  no-repeat';
            imageDiv.style.backgroundPosition = 'center';
            imageDiv.style.backgroundSize = 'cover';

            imageDiv.classList.add('center_imageFlexing');
            project.container.appendChild(imageDiv);
            setTimeout(showImage, 2500);
        }
        showImage();
    }

    function beginTyping() {
        var contentDiv = document.getElementsByClassName('text_bg')[0];
        var content, lineEl;
        var textLines = project.textLines.slice();

        function typing() {
            if (!content) {
                var textLine = textLines.shift();
                var class_name = project.mode == 'portrait' ? 'line' : 'line';
                var lineEls = document.getElementsByClassName(class_name);
                if(!textLine || lineEls.length == project.showLines){
                    var length = lineEls.length < project.showLines ? lineEls.length : project.showLines;
                    for(var i = 0; i < length; i++){
                        contentDiv.removeChild(lineEls[0]);
                    }
                }

                if (!textLine) {
                    project.textEnd = true;
                    if(project.imageEnd){
                        setTimeout(makeLargeShape, 1000);
                    }
                    return;
                }
                content = textLine.split('');
                lineEl = document.createElement('div');
                lineEl.classList.add('line');
                contentDiv.appendChild(lineEl);
            }
            var text = content.shift();
            if (text) {
                var span = document.createElement('span');
                span.classList.add('text');
                span.style.display = 'inline-block';
                span.style.animationDelay = randomNumber(0, 30) / 10 + 's';
                span.innerHTML = text.trim() ? text : '&nbsp;';
                lineEl.appendChild(span);
            } else {
                content = null;
            }
            setTimeout(typing, 200);
        }

        typing();
    }

    function randomNumber(min, max) {
        min = parseInt(min);
        max = parseInt(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function restart(){
        var imageLines = document.getElementsByClassName('imageLine');
        var length = imageLines.length;
        for(var i = 0; i < length; i++){
            project.container.removeChild(imageLines[0]);
        }
        project.imageEnd = false;
        project.textEnd = false;

        beginTyping();
        showImageFlows();
    }


    document.addEventListener('readystatechange', function(evt){
        if(document.readyState == 'complete'){
            beginTyping();
            showImageFlows();
        }
    }, false)

</script>
</body>

</html>
